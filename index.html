<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventori â€” Mobile + Google Sheets</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --sidebar:#243347; --accent:#2b7be4; --card:#ffffff; --bg:#f3f6f9; --danger:#ffe6e6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, Arial;color:#0f1724;background:var(--bg);display:flex;min-height:100vh}
  /* Sidebar */
  .sidebar{
    width:240px;background:var(--sidebar);color:#fff;flex-shrink:0;padding:18px 12px;display:flex;flex-direction:column;
    position:fixed;left:0;top:0;bottom:0;
  }
  .brand{font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .menu{list-style:none;padding:0;margin:0;flex:1}
  .menu li{padding:12px 10px;border-radius:8px;cursor:pointer;margin-bottom:6px}
  .menu li.active{background:rgba(255,255,255,0.06)}
  .sidebar-footer{font-size:12px;color:#cbd5e1;margin-top:auto}
  /* Main */
  .main{margin-left:240px;padding:18px;flex:1}
  .topbar{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .hamb{display:none;background:var(--sidebar);color:#fff;border:none;padding:8px;border-radius:8px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(19,31,58,0.04);margin-bottom:14px}
  h1,h2{margin:0 0 8px 0}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  label{font-size:13px;color:#334155}
  input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:14px}
  button{background:var(--accent);color:#fff;border:none;cursor:pointer}
  .btn-outline{background:transparent;border:1px solid #e2e8f0;color:#0f1724}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  thead th{background:#eef6ff;color:#0f1724}
  tr.low-stock{background:var(--danger)}
  /* responsive */
  @media (max-width:900px){
    .sidebar{position:fixed;transform:translateX(-100%);transition:transform .18s ease;z-index:30}
    .sidebar.open{transform:translateX(0)}
    .main{margin-left:0;padding:12px}
    .hamb{display:inline-block}
  }
  /* small helpers */
  .row{display:flex;gap:10px}
  .col{flex:1}
  .muted{color:#64748b;font-size:13px}
  .tiny{font-size:12px;color:#64748b}
  .actions{display:flex;gap:8px;align-items:center}
  .hidden{display:none!important}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="brand">ðŸ“¦ <span>Inventori</span></div>
  <ul class="menu" id="menu">
    <li data-page="dashboard" class="active">Dashboard</li>
    <li data-page="form">Form Transaksi</li>
    <li data-page="masuk">Data Masuk</li>
    <li data-page="keluar">Data Keluar</li>
    <li data-page="db">Database Barang</li>
    <li data-page="riwayat">Riwayat Transaksi</li>
  </ul>
  <div class="sidebar-footer tiny">Mobile friendly â€” Sinkron: Google Sheets (Apps Script) atau localStorage</div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <button class="hamb" id="hamb">â˜°</button>
    <h1 style="font-size:18px">Sistem Inventori</h1>
    <div style="margin-left:auto" id="syncStatus" class="tiny muted">Sync: <span id="syncLabel">local</span></div>
  </div>

  <!-- PAGES -->
  <section id="page-dashboard" class="card">
    <h2>Dashboard</h2>
    <div class="grid cols-3" style="margin-top:8px">
      <div class="card"><div class="tiny">Total Barang</div><div id="statTotalBarang" style="font-weight:700;font-size:20px">0</div></div>
      <div class="card"><div class="tiny">Total Stok</div><div id="statTotalStok" style="font-weight:700;font-size:20px">0</div></div>
      <div class="card"><div class="tiny">Hampir Habis (SOH â‰¤ Min)</div><div id="statLow" style="font-weight:700;font-size:20px">0</div></div>
    </div>
    <div class="card" style="margin-top:12px"><canvas id="chartStok" height="80"></canvas></div>
  </section>

  <section id="page-form" class="card hidden">
    <h2>Form Transaksi</h2>
    <form id="txForm" onsubmit="return false;">
      <div class="grid cols-3" style="align-items:start">
        <div>
          <label>Kode Barang</label>
          <input id="f_kode" placeholder="Kode Barang (wajib)">
        </div>
        <div>
          <label>Nama Barang</label>
          <input id="f_nama" placeholder="Nama Barang">
        </div>
        <div>
          <label>Unit (D-Unit)</label>
          <input id="f_unit" placeholder="pcs/box/kg">
        </div>

        <div>
          <label>Qty</label>
          <input id="f_qty" type="number" min="1" value="1">
        </div>
        <div>
          <label>Store</label>
          <input id="f_store" placeholder="Nama store / gudang">
        </div>
        <div>
          <label>No Receiving (opsional)</label>
          <input id="f_receiving" placeholder="No Receiving">
        </div>

        <div style="grid-column:1/4">
          <label>Keterangan</label>
          <textarea id="f_ket" placeholder="Keterangan..." rows="2"></textarea>
        </div>

        <div style="display:flex;gap:10px;grid-column:1/4;margin-top:6px">
          <button id="btnIn" type="button">âž• Masuk</button>
          <button id="btnOut" type="button" style="background:#ef4444">âž– Keluar</button>
          <button id="btnClear" type="button" class="btn-outline">Clear</button>
          <div style="margin-left:auto" class="tiny muted">Gunakan Apps Script URL untuk sinkron otomatis</div>
        </div>
      </div>
    </form>

    <h3 style="margin-top:14px">Riwayat Stock (barang yang dipilih)</h3>
    <div class="card">
      <table id="tblRiwayatStok">
        <thead><tr><th>Kode</th><th>Nama</th><th>Qty</th><th>Unit</th><th>Waktu</th><th>Store</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="page-masuk" class="card hidden">
    <h2>Data Masuk</h2>
    <div class="card"><table id="tblMasuk"><thead><tr><th>Waktu</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Store</th></tr></thead><tbody></tbody></table></div>
  </section>

  <section id="page-keluar" class="card hidden">
    <h2>Data Keluar</h2>
    <div class="card"><table id="tblKeluar"><thead><tr><th>Waktu</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Store</th></tr></thead><tbody></tbody></table></div>
  </section>

  <section id="page-db" class="card hidden">
    <h2>Database Barang (edit di sini)</h2>
    <div class="card">
      <table id="tblDB">
        <thead>
          <tr><th>Kode</th><th>Nama</th><th>D-Unit</th><th>Actual-Price</th><th>SOH QTY</th><th>Actual Amount (SOH)</th><th>Req QTY</th><th>Actual Amount (Request)</th><th>Min Stock</th><th>Max Stock</th><th>Supplier</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px" class="tiny muted">Jika item baru dibuat lewat form, hanya Kode/Nama/Unit akan terisi. Gunakan tabel ini untuk melengkapi pricing & min/max.</div>
    </div>
  </section>

  <section id="page-riwayat" class="card hidden">
    <h2>Riwayat Transaksi</h2>
    <div class="card"><table id="tblHistory"><thead><tr><th>Waktu</th><th>Jenis</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Unit</th><th>Store</th><th>Ket</th><th>No Recv</th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- small config panel -->
  <div class="card" style="margin-top:10px">
    <h3 style="margin-bottom:8px">Konfigurasi Sinkronisasi</h3>
    <div class="grid cols-2">
      <div>
        <label>Apps Script Web App URL (kosong = localStorage)</label>
        <input id="config_webapp" placeholder="https://script.google.com/macros/s/XXXXXXXX/exec">
      </div>
      <div>
        <label>ID Spreadsheet (optional)</label>
        <input id="config_sheetid" placeholder="Spreadsheet ID">
      </div>
    </div>
    <div class="tiny muted" style="margin-top:8px">Ikuti panduan Apps Script yang diberikan di README (di bawah).</div>
  </div>

</div>

<script>
/* ===========================
   Client side logic
   - fallback to localStorage if no WebApp URL provided
   - when WebApp configured, function postToGAS will push transaction
   =========================== */
const STATE_KEYS = {
  DB: 'inv_db_v2',
  IN: 'inv_in_v2',
  OUT: 'inv_out_v2',
  HISTORY: 'inv_hist_v2'
};

let db = JSON.parse(localStorage.getItem(STATE_KEYS.DB) || '[]');
let incoming = JSON.parse(localStorage.getItem(STATE_KEYS.IN) || '[]');
let outgoing = JSON.parse(localStorage.getItem(STATE_KEYS.OUT) || '[]');
let historyTx = JSON.parse(localStorage.getItem(STATE_KEYS.HISTORY) || '[]');

const el = id => document.getElementById(id);
const menuItems = document.querySelectorAll('#menu li');
menuItems.forEach(li => li.addEventListener('click', (e)=> {
  menuItems.forEach(x=>x.classList.remove('active'));
  li.classList.add('active');
  showPage(li.dataset.page);
}));

el('hamb').addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('open'));

function showPage(name){
  document.querySelectorAll('.main > section').forEach(s => s.classList.add('hidden'));
  const p = document.getElementById('page-' + name);
  if (p) p.classList.remove('hidden');
  renderAll();
}

/* render helpers */
function saveAllLocal(){
  localStorage.setItem(STATE_KEYS.DB, JSON.stringify(db));
  localStorage.setItem(STATE_KEYS.IN, JSON.stringify(incoming));
  localStorage.setItem(STATE_KEYS.OUT, JSON.stringify(outgoing));
  localStorage.setItem(STATE_KEYS.HISTORY, JSON.stringify(historyTx));
}

function renderAll(){
  renderDashboard();
  renderDB();
  renderInOut();
  renderHistory();
}

/* Dashboard */
function renderDashboard(){
  el('statTotalBarang').innerText = db.length;
  el('statTotalStok').innerText = db.reduce((s,i)=>s+(Number(i.sohQty)||0),0);
  el('statLow').innerText = db.filter(i => (Number(i.minStock)||0) >= (Number(i.sohQty)||0)).length;
  // chart (simple)
  const ctx = document.getElementById('chartStok');
  const labels = db.map(x=>x.nama || x.kode);
  const data = db.map(x=>Number(x.sohQty)||0);
  if (window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {type:'bar',data:{labels, datasets:[{label:'SOH',data, backgroundColor:'#2b7be4'}]}, options:{plugins:{legend:{display:false}}}});
}

/* Database render/edit */
function renderDB(){
  const tbody = document.querySelector('#tblDB tbody'); tbody.innerHTML = '';
  db.forEach(it => {
    const amtSOH = (Number(it.sohQty)||0) * (Number(it.actualPrice)||0);
    const amtReq = (Number(it.reqQty)||0) * (Number(it.actualPrice)||0);
    const tr = document.createElement('tr');
    if ((Number(it.sohQty)||0) <= (Number(it.minStock)||0)) tr.classList.add('low-stock');
    tr.innerHTML = `
      <td>${it.kode}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="nama">${it.nama||''}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="dunit">${it.dUnit||''}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="actualPrice">${it.actualPrice||''}</td>
      <td>${it.sohQty||0}</td>
      <td>${amtSOH.toFixed(2)}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="reqQty">${it.reqQty||''}</td>
      <td>${amtReq.toFixed(2)}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="minStock">${it.minStock||''}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="maxStock">${it.maxStock||''}</td>
      <td contenteditable="true" data-k="${it.kode}" data-field="supplierName">${it.supplierName||''}</td>
    `;
    tbody.appendChild(tr);
  });
  // attach edit events
  document.querySelectorAll('#tblDB td[contenteditable="true"]').forEach(td=>{
    td.onblur = e => {
      const k = td.getAttribute('data-k');
      const f = td.getAttribute('data-field');
      const val = td.innerText.trim();
      const item = db.find(x=>x.kode===k);
      if (!item) return;
      // try number conversion for numeric fields
      if (['actualPrice','reqQty','minStock','maxStock'].includes(f)){
        item[f] = val === '' ? '' : Number(val);
      } else item[f] = val;
      saveAllLocal();
      renderAll();
      maybePushDBUpdate(item); // optional push to Google Sheets
    };
  });
}

/* In/Out lists */
function renderInOut(){
  const tbIn = document.querySelector('#tblMasuk tbody'); tbIn.innerHTML = '';
  incoming.slice().reverse().forEach(r=> tbIn.innerHTML += `<tr><td>${r.tanggal}</td><td>${r.kode}</td><td>${r.nama}</td><td>${r.qty}</td><td>${r.store}</td></tr>`);
  const tbOut = document.querySelector('#tblKeluar tbody'); tbOut.innerHTML = '';
  outgoing.slice().reverse().forEach(r=> tbOut.innerHTML += `<tr><td>${r.tanggal}</td><td>${r.kode}</td><td>${r.nama}</td><td>${r.qty}</td><td>${r.store}</td></tr>`);
}

/* History */
function renderHistory(){
  const tb = document.querySelector('#tblHistory tbody'); tb.innerHTML = '';
  historyTx.slice().reverse().forEach(h=>{
    tb.innerHTML += `<tr><td>${h.tanggal}</td><td>${h.jenis}</td><td>${h.kode}</td><td>${h.nama}</td><td>${h.qty}</td><td>${h.unit||''}</td><td>${h.store||''}</td><td>${h.keterangan||''}</td><td>${h.receiving||''}</td></tr>`;
  });
}

/* Riwayat Stok per item */
function renderRiwayatStok(kode){
  const tbody = document.querySelector('#tblRiwayatStok tbody'); tbody.innerHTML = '';
  const items = historyTx.filter(h => h.kode === kode).slice().reverse();
  items.forEach(it => tbody.innerHTML += `<tr><td>${it.kode}</td><td>${it.nama}</td><td>${it.qty}</td><td>${it.unit||''}</td><td>${it.tanggal}</td><td>${it.store||''}</td></tr>`);
}

/* Add transaction */
document.getElementById('btnIn').addEventListener('click', ()=> doTx('Masuk'));
document.getElementById('btnOut').addEventListener('click', ()=> doTx('Keluar'));
document.getElementById('btnClear').addEventListener('click', ()=> document.getElementById('txForm').reset());

async function doTx(type){
  const kode = el('f_kode').value.trim();
  const nama = el('f_nama').value.trim();
  const unit = el('f_unit').value.trim();
  const qty = Number(el('f_qty').value);
  const store = el('f_store').value.trim();
  const ket = el('f_ket').value.trim();
  const recv = el('f_receiving').value.trim();
  if (!kode || !nama || !unit || !qty || !store) { alert('Lengkapi Kode, Nama, Unit, Qty & Store'); return; }

  // ensure item in DB
  let item = db.find(i=>i.kode===kode);
  if (!item){
    item = { kode, nama, dUnit: unit, actualPrice:'', sohQty:0, reqQty:'', minStock:'', maxStock:'', supplierName:'' };
    db.push(item);
  } else {
    // sync name/unit if changed
    item.nama = nama; item.dUnit = unit;
  }

  const waktu = new Date().toLocaleString();
  const record = { tanggal: waktu, jenis: type, kode, nama, qty, unit, store, keterangan: ket, receiving: recv };

  // update DB and lists
  if (type === 'Masuk'){
    item.sohQty = (Number(item.sohQty)||0) + qty;
    incoming.push({ tanggal:waktu, kode, nama, qty, store });
  } else {
    if ((Number(item.sohQty)||0) < qty) { alert('Stok tidak cukup!'); return; }
    item.sohQty = (Number(item.sohQty)||0) - qty;
    outgoing.push({ tanggal:waktu, kode, nama, qty, store });
  }
  historyTx.push(record);
  saveAllLocal();
  renderAll();
  renderRiwayatStok(kode);

  // Try push to Google Apps Script if configured
  const webapp = el('config_webapp').value.trim();
  const sheetid = el('config_sheetid').value.trim();
  if (webapp){
    el('syncLabel').innerText = 'syncing...';
    try {
      // Post transaction to GAS endpoint
      await postToGAS(webapp, {action:'addTransaction', sheet:null, payload: record, sheetId: sheetid});
      // Also push DB update so spreadsheet reflects latest SOH
      await postToGAS(webapp, {action:'updateItem', payload: item, sheetId: sheetid});
      el('syncLabel').innerText = 'cloud';
    } catch(err){
      console.warn('GAS push failed', err);
      el('syncLabel').innerText = 'local (push failed)';
    }
  } else {
    el('syncLabel').innerText = 'local';
  }
}

/* Optional: push DB update to GAS when editing DB inline */
async function maybePushDBUpdate(item){
  const webapp = el('config_webapp').value.trim();
  const sheetid = el('config_sheetid').value.trim();
  if (!webapp) return;
  try {
    await postToGAS(webapp, {action:'updateItem', payload:item, sheetId: sheetid});
  } catch(e){ console.warn('push failed', e); }
}

/* POST helper to GAS (Apps Script Web App) */
async function postToGAS(url, body){
  const res = await fetch(url, {
    method:'POST',
    mode:'cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error('Network response not ok: ' + res.status);
  const j = await res.json();
  if (j.status !== 'ok') throw new Error('GAS error: ' + j.message);
  return j;
}

/* Load from GAS: tries to fetch db and transactions
   GAS must support GET with ?action=getAll (optional) */
async function loadFromGAS(){
  const webapp = el('config_webapp').value.trim();
  const sheetid = el('config_sheetid').value.trim();
  if (!webapp) { el('syncLabel').innerText='local'; return; }
  try {
    el('syncLabel').innerText = 'downloading...';
    const url = webapp + '?action=getAll' + (sheetid?('&sheetId='+sheetid):'');
    const res = await fetch(url);
    const j = await res.json();
    if (j.status === 'ok' && j.data){
      db = j.data.db || db;
      incoming = j.data.incoming || incoming;
      outgoing = j.data.outgoing || outgoing;
      historyTx = j.data.history || historyTx;
      saveAllLocal();
      renderAll();
      el('syncLabel').innerText='cloud';
    } else {
      el('syncLabel').innerText='local (no data)';
    }
  } catch(e){
    console.warn('Load from GAS failed', e);
    el('syncLabel').innerText='local (fetch failed)';
  }
}

/* init */
renderAll();

/* If user fills webapp url & sheet id, try load data */
el('config_webapp').addEventListener('change', loadFromGAS);
el('config_sheetid').addEventListener('change', loadFromGAS);

/* auto load when page opens: if config present in localStorage, restore */
(function restoreConfig(){
  const savedWeb = localStorage.getItem('inv_webapp_url');
  const savedSheet = localStorage.getItem('inv_sheet_id');
  if (savedWeb) el('config_webapp').value = savedWeb;
  if (savedSheet) el('config_sheetid').value = savedSheet;
  // store when changed
  el('config_webapp').addEventListener('blur', ()=> localStorage.setItem('inv_webapp_url', el('config_webapp').value.trim()));
  el('config_sheetid').addEventListener('blur', ()=> localStorage.setItem('inv_sheet_id', el('config_sheetid').value.trim()));
  // try load if present
  if (el('config_webapp').value) setTimeout(loadFromGAS, 600);
})();

</script>
</body>
</html>